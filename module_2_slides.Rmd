---
title: "Module 2 <br><br> Exploring <br><span style='font-size: 66%'>&</span><br> Summarizing Data"
author: ""
# date: "`r Sys.Date()`"
output: 
  xaringan::moon_reader:
    lib_dir: libs
    css: [xaringan-themer.css, other.css]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---


<style type="text/css">
.remark-slide-content {
    font-size: 30px;
}
</style>
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo=T, 
  eval = F,
  message = F, 
  warning = F, 
  comment = NA,
  R.options=list(width=120), 
  cache.rebuild=F, 
  cache=T,
  fig.align='center', 
  fig.asp = .7,
  dev = 'svg', 
  dev.args=list(bg = 'transparent')
)

library(tidyverse); library(broom); library(kableExtra); library(visibly)

kable_df <- function(..., digits=3) {
  kable(..., digits=digits) %>% 
    kable_styling(full_width = F)
}

rnd = function(x, digits = 3) arm::fround(x, digits = digits)
```

## Introduction

---

## Quick Summary

It's always a good idea to glance at the data

Get a feel for the data types

Spot potential issues

```{r summary}
glimpse(demographics)
summary(demographics[,1:10])
```

---

## Grouping and Summarizing Operations

A very common operation is to do things by group(s) then create new summary variables.

```{r group_by, eval=TRUE}
demographics %>% 
  group_by(libuser) %>% 
  summarise(age = mean(age, na.rm = T)) 
```

---

## Grouping and Summarizing Operations

Can do multiple operations at once

```{r group_by2, eval=TRUE}
demographics %>% 
  group_by(libuser) %>% 
  summarise(age_mean = mean(age, na.rm = T),
            age_sd = sd(age, na.rm = T),
            age_max = max(age, na.rm = T),
            prop_male = mean(gender=='Male', na.rm = T)) 
```

---

##  Mapping functions to groups


Use the <span class="pack">purrr</span> package (part of <span class="pack">tidyverse</span>)

Consider the following: weâ€™ll use the <span class="func">map</span> function to *map* the <span class="func">sum</span> function to each element in the list

```{r map, eval=TRUE}
x = list(1:3, 4:6, 7:9)
map(x, sum)
```

---

## Grouping and Summarizing Operations

We can even do this with modeling and other operations.

```{r group_by3, eval=TRUE}
model_variables = read.csv('data/model_variables_anonymized.csv')

model_variables %>% 
  group_split(race) %>% 
  map(~coef(lm(award_total_amount ~ gender, data = .))) 
```

---
## Visualization

Visualizing data requires that you:
- Consider carefully the information you want to display
- And then how you want to display it

Tell a story with the data.

And have some fun with it!

---

## Things to think about


<span style="color: cornflowerblue">Color</span>

<span style="color: black">Contrast</span>

<span style="font-size: 200%">Size</span>

<span style="color: #0000001A">Transparency</span>

<span style="font-variant: small-caps; font-family: 'Alex Brush'">Legibility</span>

<span style="color: red">Access</span><span style="color: green">ibility</span>

File types

---

## ggplot2

The most widely used visualization package in R

Copied into other realms (e.g. Python)

---

## Layers

Visualization can be thought of in a layered fashion


<div style="margin-left: 0%">base</div>
<div style="margin-left: 10%">main plot</div>
<div style="margin-left: 20%">options</div>
    
---

## More pipes

ggplot2 uses a `+` as a pipe to add layers

```{r ggplot2}
library(ggplot2)
ggplot(data) +
  geom_point(aes(x = var1, y = var2)) +
  geom_line() +
  theme(plot.caption = element_text(size = 6))
```

We can pipe *to* any ggplot as we did before (` %>% `)

---

## Aesthetics

<span class="emph">Aesthetics</span> (`aes`) map variables to visual properties

<span class="emph">Geoms</span> are the geometric units we want to display


---

## Aesthetics

```{r aesthetics}
model_variables %>% 
  filter(award_total_amount >= 50000) %>% 
ggplot() +
  geom_density(aes(x = award_total_amount, 
                   color = gender,
                   fill = gender),
               alpha = .2) + 
  scale_x_continuous(breaks = c(1e5, 1e6, 1e7, 1e8), trans = 'log')
```


---

## Aesthetics

```{r aesthetics2, eval=TRUE, echo=FALSE}
model_variables %>% 
  filter(award_total_amount >= 50000) %>% 
  ggplot() +
  geom_density(aes(x = award_total_amount, 
                   color = gender,
                   fill = gender),
               alpha = .2) + 
  scale_x_continuous(breaks = c(1e5, 1e6, 1e7, 1e8), trans = 'log')
```

---


## Stats

We can also use ggplot2 to create statistics we want to visualize

```{r ggstats}
model_variables %>% 
  ggplot() 
  stat_density(award_total_amount >= 50000) %>% 
```


---

## Stats

---

## Scales

```{r scales2, eval=TRUE, echo=FALSE}
model_variables %>% 
  filter(award_total_amount >= 50000) %>% 
  ggplot() +
  geom_density(aes(x = award_total_amount, 
                   color = gender,
                   fill = gender),
               alpha = .2) + 
  scale_x_continuous(breaks = c(1e5, 1e6, 1e7, 1e8), 
                     trans = 'log') +
  scale_fill_viridis_d(begin = .25, end = .5) +
  scale_color_viridis_d(begin = .25, end = .5) 
```
---

## Scales


---

## Facets

---
## Facets

---

## Interactivity

---

## Interactivity


General 

- [plotly](https://plot.ly/r/)
  - used also in Python, Matlab, Julia
  - can convert <span class="pack">ggplot2</span> images to interactive ones (with varying degrees of success)
- [highcharter](http://jkunst.com/highcharter/)
  - also very general wrapper for highcharts.js and works with some R packages out of the box
- [rbokeh](http://hafen.github.io/rbokeh/)
  - like plotly, it also has cross language support

---

## Interactivity

Specific functionality:

- [DT](https://rstudio.github.io/DT/)
  - interactive data tables
- [leaflet](https://rstudio.github.io/leaflet/)
    - maps with OpenStreetMap
- [visNetwork](http://datastorm-open.github.io/visNetwork/)
    - Network visualization
    
---

## Plotly

plotly has modes, which allow for points, lines, text and combinations. Traces, add_*, work similar to geoms.

---

## Plotly

```{r plotly}
library(plotly)
midwest %>% 
  filter(inmetro==T) %>% 
  plot_ly(x=~percbelowpoverty, y=~percollege) %>% 
  add_markers()
```

---
## Plotly

```{r}
library(mgcv); library(modelr); library(glue)

mtcars %>% 
  mutate(amFactor = factor(am, labels=c('auto', 'manual')),
         hovertext = glue('weight: {wt} <br> mgp:  {mpg} <br> {amFactor}')) %>% 
  add_predictions(gam(mpg~s(wt, am, bs='fs'), data=mtcars)) %>% 
  plot_ly() %>%
  add_markers(x=~wt, 
              y=~mpg, 
              color=~amFactor, 
              opacity=.5, 
              text=~hovertext, 
              hoverinfo='text', 
              showlegend=F) %>% 
  add_lines(x=~wt, 
            y=~pred, 
            color=~amFactor, 
            name='gam prediction')
```

---

## Plotly


One of the strengths of plotly is that we can feed a ggplot object to it, and turn our formerly static plots into interactive ones. 

```{r}
gp = mtcars %>% 
  mutate(amFactor = factor(am, labels=c('auto', 'manual')),
         hovertext = paste(wt, mpg, amFactor)) %>% 
  arrange(wt) %>% 
  ggplot(aes(x=wt, y=mpg, color=amFactor)) +
  geom_smooth(se=F) +
  geom_point(aes(color=amFactor))
ggplotly()
```

---